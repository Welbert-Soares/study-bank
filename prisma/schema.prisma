// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                    @id
  email                 String                    @unique
  name                  String?
  imageUrl              String?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  // Relações
  ferramentas           FerramentaPersonalizada[]
  planos                Plano[]
  disciplinas           Disciplina[]
  ciclosPomodoro        CicloPomodoro[]
  planejamentosSemanais PlanejamentoSemanal[]
  estudosRealizados     EstudoRealizado[]
}

enum DiaDaSemana {
  Domingo
  Segunda
  Terca
  Quarta
  Quinta
  Sexta
  Sabado
}

enum StatusConteudo {
  pendente
  em_progresso
  concluido
}

model FerramentaPersonalizada {
  id           String   @id @default(cuid())
  userId       String // Relação com o usuário
  nome         String
  descricao    String?
  url          String
  tipo         String // Exemplo: "kanban", "flashcards", "estudar", "continuar"
  icone        String?
  ordem        Int      @default(0)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relações
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ========================================
// NOVOS MODELOS - Sistema Estudei Style
// ========================================

// Plano de Estudos (novo conceito - substitui PlanoDeEstudos)
model Plano {
  id           String   @id @default(cuid())
  userId       String
  nome         String
  emblema      String?  @db.Text // URL da imagem ou base64
  edital       String? // Nome do edital (ex: "Polícia Federal")
  cargo        String? // Nome do cargo (ex: "Agente de Polícia Federal")
  observacoes  String?  @db.Text
  ativo        Boolean  @default(true)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relações
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  disciplinas           Disciplina[]
  planejamentosSemanais PlanejamentoSemanal[]

  @@index([userId])
  @@index([ativo])
}

// Disciplina (nova estrutura com hierarquia de tópicos)
model Disciplina {
  id           String         @id @default(cuid())
  userId       String
  planoId      String
  nome         String
  cor          String? // Cor personalizada em hexadecimal (ex: "#3DD9B3")
  descricao    String?        @db.Text
  ordem        Int            @default(0)
  edital       String? // Badge do edital (ex: "PF", "TRF", etc)
  cargo        String? // Cargo relacionado
  status       StatusConteudo @default(pendente)
  criadoEm     DateTime       @default(now())
  atualizadoEm DateTime       @updatedAt

  // Relações
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  plano          Plano           @relation(fields: [planoId], references: [id], onDelete: Cascade)
  topicos        Topico[]
  ciclosPomodoro CicloPomodoro[]

  @@index([userId])
  @@index([planoId])
  @@index([status])
}

// Tópico (conteúdo dentro de uma disciplina)
model Topico {
  id           String         @id @default(cuid())
  disciplinaId String
  ordem        Int
  titulo       String
  conteudo     String?        @db.Text // Conteúdo detalhado do tópico
  status       StatusConteudo @default(pendente)
  criadoEm     DateTime       @default(now())
  atualizadoEm DateTime       @updatedAt

  // Relações
  disciplina Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)

  @@index([disciplinaId])
  @@index([status])
}

// Ciclo Pomodoro (sistema de planejamento de estudos por tempo)
model CicloPomodoro {
  id           String   @id @default(cuid())
  userId       String
  disciplinaId String
  duracao      Int // Duração em minutos
  ordem        Int // Ordem no ciclo de estudos
  completo     Boolean  @default(false)
  data         DateTime @default(now()) // Data do ciclo
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relações
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  disciplina Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([disciplinaId])
  @@index([data])
  @@index([completo])
}

// Planejamento Semanal (distribui disciplinas pela semana)
model PlanejamentoSemanal {
  id                  String   @id @default(cuid())
  userId              String
  planoId             String
  nome                String // Ex: "Semana 1 - Revisão Geral"
  dataInicio          DateTime // Início da semana (Segunda-feira)
  dataFim             DateTime // Fim da semana (Domingo)
  ativo               Boolean  @default(true)
  // Configurações do wizard
  horasPorDia         Int // Total de horas disponíveis por dia
  tempoMinimo         Int // Tempo mínimo de estudo por sessão (em minutos)
  tempoMaximo         Int // Tempo máximo de estudo por sessão (em minutos)
  diasDisponiveis     String // JSON: ["Segunda", "Terca", "Quarta"...] - Dias da semana selecionados
  horariosDisponiveis String   @db.Text // JSON: {Segunda: {inicio: "08:00", fim: "12:00"}, ...}
  // Disciplinas e seus pesos
  configuracoes       String   @db.Text // JSON: [{disciplinaId, nome, cor, importancia, conhecimento, percentual}]
  // Grade semanal gerada
  distribuicao        String   @db.Text // JSON: {Segunda: [{disciplinaId, nome, cor, inicio, fim, duracao, estudoRealizadoId}], ...}
  criadoEm            DateTime @default(now())
  atualizadoEm        DateTime @updatedAt

  // Relações
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plano Plano @relation(fields: [planoId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planoId])
  @@index([ativo])
  @@index([dataInicio])
}

// Estudo Realizado (registro de estudos concluídos)
model EstudoRealizado {
  id                    String   @id @default(cuid())
  userId                String
  planoId               String
  disciplinaId          String
  topicoId              String?
  planejamentoSemanalId String? // ID do planejamento semanal (se vier de um agendamento)
  agendamentoKey        String? // Chave única do agendamento (ex: "Segunda_0" para identificar a sessão específica)
  dataEstudo            DateTime
  tempoEstudado         Int // Em minutos
  categoria             String // "teoria", "exercicios", "revisao"
  material              String? // Material estudado
  teoriaFinalizada      Boolean  @default(false)
  anotacoes             String?  @db.Text // JSON com questões, páginas, vídeos, comentários
  criadoEm              DateTime @default(now())
  atualizadoEm          DateTime @updatedAt

  // Relações
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planoId])
  @@index([disciplinaId])
  @@index([dataEstudo])
}
